task :default => [:build]

desc "Builds the solution using Mono"
task :build do
  sh "./.paket/paket.exe install"
  sh "xbuild /verbosity:quiet"
end

desc "Run tests for all modules"
task :test do
  Rake::Task['test:access_control'].invoke
end

namespace :test do

  desc "Run tests for Access Control module"
  task :access_control do
    sh "chmod a+x ./packages/NUnit.ConsoleRunner/tools/nunit3-console.exe"
    sh "./packages/NUnit.ConsoleRunner/tools/nunit3-console.exe ./Modules/AccessControl/Tests/bin/Debug/Trackwane.AccessControl.Tests.dll"
  end

  desc "Run tests for Management module"
  task :management do
    sh "chmod a+x ./packages/NUnit.ConsoleRunner/tools/nunit3-console.exe"
    sh "./packages/NUnit.ConsoleRunner/tools/nunit3-console.exe ./Modules/AccessControl/Tests/bin/Debug/Trackwane.AccessControl.Tests.dll"
  end

  desc "Run tests for Data module"
  task :data do
    sh "chmod a+x ./packages/NUnit.ConsoleRunner/tools/nunit3-console.exe"
    sh "./packages/NUnit.ConsoleRunner/tools/nunit3-console.exe ./Modules/AccessControl/Tests/bin/Debug/Trackwane.AccessControl.Tests.dll"
  end

  desc "Run tests for Simulat module"
  task :simulator do
    sh "chmod a+x ./packages/NUnit.ConsoleRunner/tools/nunit3-console.exe"
    sh "./packages/NUnit.ConsoleRunner/tools/nunit3-console.exe ./Modules/AccessControl/Tests/bin/Debug/Trackwane.AccessControl.Tests.dll"
  end

  desc "Run tests for Analysis module"
  task :analysis do
    sh "chmod a+x ./packages/NUnit.ConsoleRunner/tools/nunit3-console.exe"
    sh "./packages/NUnit.ConsoleRunner/tools/nunit3-console.exe ./Modules/AccessControl/Tests/bin/Debug/Trackwane.AccessControl.Tests.dll"
  end

end

task :docker do
  Rake::Task['docker:running'].invoke
end

namespace :docker do

  desc "Shows running containers for solution"
  task :running do
    sh "docker-compose ps"
  end

  desc "Starts all containers"
  task :up do
    sh "docker-compose up -d"
  end

  desc "Shows container logs"
  task :logs do
    sh "docker-compose logs"
  end

  desc "Stops all containers"
  task :down do
    sh "docker-compose down &"
  end

end
